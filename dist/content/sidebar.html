<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIç½‘é¡µåŠ©æ‰‹</title>
  <style>
    /* ä¾§è¾¹æ æ ·å¼å°†é€šè¿‡content.jsæ³¨å…¥ */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-container {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 12px 16px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #4285F4;
      color: white;
    }
    
    .sidebar-header h3 {
      margin: 0;
      font-size: 16px;
      font-weight: 500;
    }
    
    .sidebar-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
    }
    
    .sidebar-close-btn:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    
    .sidebar-conversation {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
      background-color: #f8f9fa;
    }
    
    .sidebar-input {
      padding: 12px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      background-color: white;
    }
    
    .sidebar-input textarea {
      flex: 1;
      border: 1px solid #e0e0e0;
      border-radius: 18px;
      padding: 8px 12px;
      font-size: 14px;
      resize: none;
      font-family: inherit;
      outline: none;
    }
    
    .sidebar-input textarea:focus {
      border-color: #4285F4;
    }
    
    .send-btn {
      background-color: #4285F4;
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-left: 8px;
      align-self: flex-end;
    }
    
    .send-btn:hover {
      background-color: #3367d6;
    }
    
    .send-btn svg {
      width: 20px;
      height: 20px;
    }
  </style>
</head>
<body>
  <div class="sidebar-container">
    <div class="sidebar-header">
      <h3>AIç½‘é¡µåŠ©æ‰‹</h3>
      <button class="sidebar-close-btn" id="close-btn" title="å…³é—­ä¾§è¾¹æ ">Ã—</button>
    </div>
    
    <div class="sidebar-conversation" id="conversation-container">
      <div class="welcome-message">
        <p>ğŸ‘‹ ä½ å¥½ï¼æˆ‘æ˜¯AIç½‘é¡µåŠ©æ‰‹ã€‚</p>
        <p>æˆ‘å·²ç»é˜…è¯»äº†è¿™ä¸ªç½‘é¡µçš„å†…å®¹ï¼Œä½ å¯ä»¥é—®æˆ‘ä»»ä½•å…³äºè¿™ä¸ªç½‘é¡µçš„é—®é¢˜ã€‚</p>
      </div>
      <div id="messages-container"></div>
    </div>
    
    <div class="sidebar-input">
      <textarea id="input-text" placeholder="è¾“å…¥ä½ çš„é—®é¢˜..." rows="2"></textarea>
      <button class="send-btn" id="send-btn" title="å‘é€">
        <svg viewBox="0 0 24 24" width="24" height="24">
          <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
        </svg>
      </button>
    </div>
  </div>
  
  <script>
    // ä¾§è¾¹æ ä¸å†…å®¹è„šæœ¬é€šä¿¡
    document.getElementById('close-btn').addEventListener('click', () => {
      window.parent.postMessage({ action: 'closeSidebar' }, '*');
    });
    
    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('input-text').addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });
    
    function sendMessage() {
      const inputText = document.getElementById('input-text');
      const message = inputText.value.trim();
      
      if (message) {
        window.parent.postMessage({ action: 'sendMessage', message }, '*');
        inputText.value = '';
      }
    }
    
    // æ¥æ”¶æ¥è‡ªå†…å®¹è„šæœ¬çš„æ¶ˆæ¯
    window.addEventListener('message', (event) => {
      const { action, data } = event.data;
      
      switch (action) {
        case 'addMessage':
          addMessage(data.text, data.isUser, data.isError);
          break;
        case 'showLoading':
          showLoadingIndicator();
          break;
        case 'hideLoading':
          hideLoadingIndicator();
          break;
      }
    });
    
    function addMessage(text, isUser, isError = false) {
      const messagesContainer = document.getElementById('messages-container');
      
      const messageEl = document.createElement('div');
      messageEl.classList.add('message');
      messageEl.classList.add(isUser ? 'user-message' : 'assistant-message');
      if (isError) messageEl.classList.add('error-message');
      
      messageEl.innerHTML = `
        <div class="message-content">
          ${formatMessage(text)}
        </div>
        ${!isUser ? '<button class="copy-btn" title="å¤åˆ¶å›ç­”">å¤åˆ¶</button>' : ''}
      `;
      
      messagesContainer.appendChild(messageEl);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      const conversationContainer = document.getElementById('conversation-container');
      conversationContainer.scrollTop = conversationContainer.scrollHeight;
      
      // æ·»åŠ å¤åˆ¶æŒ‰é’®äº‹ä»¶
      if (!isUser) {
        const copyBtn = messageEl.querySelector('.copy-btn');
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(text).then(() => {
            copyBtn.textContent = 'å·²å¤åˆ¶';
            setTimeout(() => {
              copyBtn.textContent = 'å¤åˆ¶';
            }, 2000);
          });
        });
      }
    }
    
    function formatMessage(text) {
      // ç®€å•çš„Markdownæ ¼å¼æ”¯æŒ
      return text
        // ä»£ç å—
        .replace(/```([\s\S]*?)```/g, '<pre><code>$1</code></pre>')
        // è¡Œå†…ä»£ç 
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // ç²—ä½“
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        // æ–œä½“
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        // é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        // æ¢è¡Œ
        .replace(/\n/g, '<br>');
    }
    
    function showLoadingIndicator() {
      const messagesContainer = document.getElementById('messages-container');
      
      // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŠ è½½æŒ‡ç¤ºå™¨
      let loadingEl = document.querySelector('.loading-indicator');
      if (loadingEl) return;
      
      // åˆ›å»ºåŠ è½½æŒ‡ç¤ºå™¨
      loadingEl = document.createElement('div');
      loadingEl.classList.add('message', 'assistant-message', 'loading-indicator');
      loadingEl.innerHTML = `
        <div class="message-content">
          <div class="typing-indicator">
            <span></span>
            <span></span>
            <span></span>
          </div>
        </div>
      `;
      
      messagesContainer.appendChild(loadingEl);
      
      // æ»šåŠ¨åˆ°åº•éƒ¨
      const conversationContainer = document.getElementById('conversation-container');
      conversationContainer.scrollTop = conversationContainer.scrollHeight;
    }
    
    function hideLoadingIndicator() {
      const loadingEl = document.querySelector('.loading-indicator');
      if (loadingEl) {
        loadingEl.remove();
      }
    }
  </script>
</body>
</html>
